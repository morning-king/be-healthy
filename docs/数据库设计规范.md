# BeHealthy 数据库设计规范

## 1. 概述
本规范旨在统一 BeHealthy 项目的数据库设计标准，确保数据的一致性、完整性、安全性和可维护性。

## 2. 数据库选型
*   **类型**: SQLite (通过 Room Persistence Library 访问)
*   **版本管理**: 使用 Room 的 Migration 机制进行版本控制。

## 3. 命名规范
*   **表名**: 使用小写字母和下划线 `snake_case`，如 `user_profile`, `fitness_tasks`。
*   **列名**: 使用小写字母和下划线 `snake_case`，如 `created_at`, `user_id`。
*   **主键**: 统一命名为 `id`，类型为 `Long` 或 `Int`，通常自增。
*   **外键**: 命名为 `target_table_id`，如 `user_id`。
*   **索引**: `idx_table_column`，如 `idx_poems_author`。

## 4. 字段设计规范
*   **非空约束**: 除非业务逻辑明确允许为空，否则字段应设为 `NOT NULL`。
*   **默认值**: 为布尔值、枚举值提供默认值。
*   **时间存储**:
    *   日期: `TEXT` (Format: `YYYY-MM-DD`) 或 `INTEGER` (Epoch Day)。
    *   时间戳: `INTEGER` (Epoch Milliseconds)。
*   **布尔值**: 使用 `INTEGER` (0/1) 存储 (SQLite 无原生 Boolean)。

## 5. 表结构定义

### 5.1 用户档案 (user_profile)
存储用户基本信息及偏好设置。
*   `id`: INTEGER PRIMARY KEY
*   `nickname`: TEXT
*   `avatar_uri`: TEXT
*   `gender`: INTEGER
*   `birthday`: TEXT (YYYY-MM-DD)

### 5.2 每日一言 (quotes)
*   `id`: INTEGER PRIMARY KEY
*   `content`: TEXT
*   `source`: TEXT
*   `category`: TEXT

### 5.3 每日诗词 (poems)
*   `id`: INTEGER PRIMARY KEY
*   `content`: TEXT
*   `author`: TEXT
*   `title`: TEXT
*   `dynasty`: TEXT

### 5.4 每日历史 (daily_history)
记录每日推荐的历史，用于去重和算法分析。
*   `id`: INTEGER PRIMARY KEY
*   `date`: TEXT (YYYY-MM-DD)
*   `type`: TEXT ("quote" | "poem")
*   `item_id`: INTEGER

## 6. 备份与恢复策略
*   **自动备份**: 每日凌晨 2:00 - 4:00 自动执行全量备份。
*   **保留策略**: 本地保留最近 30 天的备份文件。
*   **触发机制**:
    *   每日定时任务 (WorkManager)。
    *   数据库版本升级前 (Pre-migration)。
    *   用户手动触发。
*   **存储路径**: App 私有目录 `files/database_backups/`。
*   **文件命名**: `behealthy_db_[auto|manual]_YYYYMMDD_HHmmss.bak`

## 7. 安全性
*   **访问控制**: 数据库文件位于 App 私有目录，未 Root 设备无法直接访问。
*   **敏感数据**: 敏感字段（如密码、Token）应加密存储（目前项目暂无此类需求）。
*   **SQL 注入**: 必须通过 Room DAO (参数化查询) 访问数据库，严禁拼接 SQL。

## 8. 变更管理
*   **DDL 变更**:
    1.  修改 Entity 类。
    2.  增加 Database Version。
    3.  编写 Migration 脚本。
    4.  **必须**在变更前触发一次自动备份。
    5.  严禁使用 `fallbackToDestructiveMigration` (开发阶段除外，上线后禁止)。
